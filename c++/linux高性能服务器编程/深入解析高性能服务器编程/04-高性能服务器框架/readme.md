
| 模块         | 单个服务器程序             | 服务器集群                   |
| ------------ | -------------------------- | ---------------------------- |
| I/O处理单元  | 处理客户连接，读写网络数据 | 作为接入服务器，实现负载均衡 |
| 逻辑单元     | 业务进程或线程             | 逻辑服务器                   |
| 网络存储单元 | 本地数据库、文件或缓存     | 数据库服务器                 |
| 请求队列     | 各单元之间的通信方式       | 各服务器之间的永久TCP连接    |


## I/O模型
- 阻塞的文件描述符-阻塞I/O
  - 系统调用可能因无法立即完成，而被操作系统挂起，直到等待的时间发生为止
- 非阻塞的文件描述符-非阻塞I/O
  - 系统调用总是立即返回，不管事件是否已发生
    - 如果没有立即发生，则返回-1（跟出错的返回一样-1），此时必须根据errno来区分
      - 对accept、send、recv，事件未发生errno通常设置为EAGAIN(意为：再来一次) 或EWOULDBLOCK(意为：期望阻塞)
      - 对connect，事件未发生errno设置为EINPROGRESS(意为：在处理中)


- 【同步I/O】：I/O的读写操作，都是发生在I/O事件之后，由应用程序完成
  - 阻塞I/O
  - I/O复用：I/O通知机制
    - 应用程序通过I/O复用函数，向内核注册一组事件，内核通过I/O复用函数将其中 就绪的事件通知给应用程序
    - 如：select、poll、epoll_wait
  - SIGIO信号：报告I/O事件
    - 为一个目标文件描述符指定宿主进程，那么指定的宿主进程将捕获到SIGIO信号
    - 当目标文件描述符有指定事件发生时，SIGIO信号的信号处理函数将被触发
- 【异步I/O】：用户可直接对I/O执行读写操作
  - 操作告诉内核 用户读写缓冲区的位置，以及I/O操作完成之后内核通知应用程序的方式

## 事件处理模式

服务器程序通常需要处理一下三类事件：
- I/O事件
- 信号
- 定时事件

两种高效的事件处理模式
- Reactor,  同步I/O模型通常用于实现Reactor模式
  - 要求主线程（I/O处理单元）只负责监听 文件描述上是否有事件发生；有则立即将该事件通知工作线程（逻辑单元）；除此之外，主线程不做任何实质性工作。 读写数据、接受新的连接，以及处理客户端请求均在工作线程中完成
  - 使用同步I/O模型（以epoll_wait为例），实现Reactor模式的工作流程是：
    1. 主线程往 epoll内核事件表中注册 socket上的读就绪事件
    2. 主线程调用epoll_wait等待socket上有数据可读
    3. 当socket上有数据可读时，epoll_wait通知主线程。 主线程则将socket可读事件放入请求队列
    4. 睡眠在请求队列上的某个工作线程被唤醒，他从socket读取数据， 并处理客户请求， 然后往epoll内核事件表中注册该socket上的写就绪事件
    5. 主线程调用epoll_wait等待socket可写
    6. 当socke可写时，epoll_wait通知主线程。 主线程将socket可写事件放入请求队列
    7. 睡眠在请求队列上的某个工作线程被唤醒，他往socket上写入服务器处理客户端请求的结果

- Proactor, 异步I/O模型用于实现Proactor模式
  - 将所有的I/O操作都交给主线程和内核来处理，工作线程仅负责业务逻辑
  - 使用异步I/O模型（以aio_read和aio_write为例），实现Proactor模式的工作流程是：
    1. 主线程调用aio_read函数向内核注册socket上的读完成事件，并告诉内核用户读缓冲区的位置，以及读操作完成时如何通知应用程序
    2. 主线程继续处理其他逻辑
    3. 当socket上的数据被读入用户缓冲区后，内核将向应用程序发生一个信号，以通知应用程序数据已经可用
    4. 应用程序预先定义好的信号处理函数，选择一个工作线程来处理客户请求                                                                                   
                                                                  
